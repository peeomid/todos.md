# tmd Interactive Mode – Requirements

> This document defines the interactive TUI (“terminal user interface”) for `tmd`.
> It assumes you already know the `tmd` CLI, todo format, and `tmd index`.

---

## 1. Purpose & Data Flow

### 1.1. Goal

`tmd interactive` is a full-screen terminal UI (TUI) for working with todos faster and more comfortably than typing CLI commands.

It should let you:

* See **Today** and other views at a glance.
* Navigate tasks with **vim keys + arrows**.
* **Edit tasks** (status, priority, bucket, plan, due, text) via small menus.
* **Search/filter live** within any view (plus global search).
* Keep **Markdown (`todos.md`) as the single source of truth**.

### 1.2. Data sources

* **Canonical data**: Markdown files (primarily `todos.md`, plus any other task-bearing `.md` files you choose).
* **Index/cache**: `todos.json` (or the configured `output` path) generated by `tmd index`.

### 1.3. Lifecycle of `tmd interactive`

1. **Start**

 * Show a clear startup status (so the user knows the app is working), e.g.:
   * `Starting…`
   * `Running enrich…`
   * `Running index…`
   * `Loading todos.json…`
 * Run `tmd enrich` automatically to ensure every task has an `id:` (and to canonicalize shorthands if present).
 * Run `tmd index` automatically.
 * Load tasks from `todos.json` (or the configured `output` path) into memory.
2. **During session**

 * All reads/searches use the in-memory task list.
 * All edits write directly to the Markdown files.
 * In-memory tasks are updated to match each edit.
3. **Exit**

 * Show a clear exit status (so it doesn’t look like the terminal is “hung”), e.g.:
   * `Exiting…`
   * `Reindexing…`
   * `Syncing…`
   * `Done.`
 * Run `tmd index` again to resync `todos.json` with Markdown.
 * Run `tmd sync` once to regenerate view files.
 * Exit to shell.

---

## 2. Screen Layout & Colors

### 2.1. Core layout (ASCII)

Rough layout:

```text
┌────────────────────────── tmd – Today (bucket:today) ──────────────────────────┐
[1] Today [2] Upcoming [3] Anytime [4] Someday [5] Projects [/] Search 
├────────────────────────────── Task List ─────────────────────────────────────┤
│ [ ] A  Draft welcome email               as-onb:1   plan:2025-12-18   60m   │
│ [x] N  Call bank about card              life:2     plan:2025-12-18   15m   │
│ [ ] N  Refactor onboarding flow          as-onb:2   bucket:upcoming         │
│ [ ] L  Small copy tweak                  as-onb:3   bucket:anytime          │
│                                                                              │
│ View: Today (1)  |  Query: status:open bucket:today  |  Flags: hide-done  ? │
├──────────────────────────── Details / Help ──────────────────────────────────┤
│ Draft welcome email                                                         │
│ project: as-onb   area: sidebiz   bucket: today   priority: high            │
│ energy: normal   plan: 2025-12-18   due: -   est: 60m                       │
│ file: projects/autosenso.md:23                                              │
│                                                                              │
│ [j/k/↑/↓] move  [space] toggle done  [p] priority  [b] bucket  [/] search   │
│ [n] plan  [d] due  [a] add  [0–9] views  [z] show/hide done  [q] quit       │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 2.2. Color usage

Use a small, meaningful color palette:

* **Selected row**: highlighted (reverse video or accent background).
* **Status**:

 * Done tasks: dim/faded (e.g. same color but “dim” attribute).
* **Priority**:

 * `priority:high` – accent color (e.g. bright red/yellow).
 * `priority:normal` – default color.
 * `priority:low` – grey/faint.
* **Bucket** (in details or small tag in list):

 * `today` – accent (e.g. cyan).
 * `upcoming` – another accent (e.g. blue).
 * `someday` – dim.

Colors should be:

* Defined centrally (e.g. via color pairs).
* Optional / configurable (a “no color” mode later).

---

## 2.3. Library decision matrix (v1)

We want stable, minimal dependencies, good performance, and decent testability.

| Option | Pros | Cons | Testability notes |
|---|---|---|---|
| `terminal-kit` | Minimal deps; fast; low-level control; easy to keep stable long-term | More manual UI plumbing (list behavior, focus, popups) | Drive input via a fake `stdin` and capture output via a fake `stdout`; keep “state transitions” separate from rendering for unit tests |
| Ink (React) | Strong structure; component model; rich ecosystem | Heavier deps (React); more framework overhead than needed for a small stable tool | Unit-test components/state naturally; still need integration-style tests for keybindings and terminal output |

Decision: use `terminal-kit` for v1.

---

## 3. Views

### 3.1. Built-in views

Each view has:

* A **key** (for quick jump).
* A **name**.
* A **base query** (same syntax as `tmd list` filter language).
* A **default sort**.

Built-ins (v1):

* **0 – All**

 * `key: "0"`
 * `name: "All"`
 * `base query`: all tasks (filtered by show/hide done flag).
* **1 – Today**

 * `key: "1"`
 * `name: "Today"`
 * `base query`: `status:open bucket:today`

 * (optional extension later: include `plan:today` / `due:today` / overdue).
* **2 – Upcoming**

 * `key: "2"`
 * `name: "Upcoming"`
 * `base query`: `status:open bucket:upcoming`
* **3 – Anytime**

 * `key: "3"`
 * `name: "Anytime"`
 * `base query`: `status:open bucket:anytime`
* **4 – Someday**

 * `key: "4"`
 * `name: "Someday"`
 * `base query`: `status:open bucket:someday`
* **5 – Projects**

 * `key: "5"`
 * `name: "Projects"`
 * Shows a list of projects, not tasks.
 * Selecting a project opens a project-specific task list (like `status:open project:<id>`).

### 3.2. Custom views (config)

In `tmd` config (e.g. YAML):

```yaml
views:
 - key: "6"
 name: "High Impact"
 query: "status:open priority:high"
 sort: "bucket,plan,due"

 - key: "7"
 name: "Work – This Week"
 query: "status:open area:work plan:this-week"
 sort: "plan,due,priority"
```

Requirements:

* `key`: single character (`0–9`, or letters).
* `name`: label in UI.
* `query`: filter string.
* `sort` (optional): comma-separated fields; fallback to default sort if missing.

Custom views are part of the view cycle (`h/l` / left/right).

---

## 4. Navigation & Keybindings

### 4.1. Global navigation

* `q` – quit interactive mode.
* `?` – show help/cheatsheet.
* `r` – refresh (re-read `todos.json` without restarting; optional v2).
* `0–9` – jump to specific view (0 = All, 1 = Today, etc.).
* `h` / `←` – previous view.
* `l` / `→` – next view.

### 4.2. Task list navigation (vim style + arrows)

* `j` / `↓` – move selection down.
* `k` / `↑` – move selection up.
* `g` – jump to top.
* `G` – jump to bottom.
* `Ctrl+U` / `PgUp` – half page up.
* `Ctrl+D` / `PgDn` – half page down.

---

## 5. Search & Filtering

### 5.1. Entering search mode

* `/` – enter live search mode **scoped to current view**.

Behavior:

* A search bar appears at bottom.
* Input is **pre-filled** with the view’s base query.
* On every keypress, the task list is re-filtered.

Example in Today view:

```text
Search (scope: view): status:open bucket:today _
```

You can:

* Add text filter: `text:stripe`
* Add more filters: `priority:high`, `area:work`, etc.

Resulting query used:

* `(<view base query>) + (whatever is in the search bar)`

### 5.2. Scope toggle (view vs global)

Inside search bar:

* `!` or `Ctrl+/` – toggle between:

 * **View scope**: base query of view + search string.
 * **Global scope**: ignore view base query, use search string alone.

Prompt example:

```text
Search (scope: global): text:stripe priority:high _
```

### 5.3. Exiting search

* `Esc` or `Ctrl+C`:

 * Leave search mode.
 * Restore task list to base view query (no extra filters).
 * Hide search bar.

### 5.4. Query display

The top bar’s “Query” section shows:

* The **actual query** used right now.
* E.g. in search:

 ```text
 View: Today (1) | Query: status:open bucket:today text:stripe priority:high | Flags: hide-done
 ```

---

## 6. Show / Hide Done Tasks

Global toggle:

* `z` – toggle between hiding and showing done tasks.

Behavior:

* Maintains an internal flag: `show_done` boolean.
* When `show_done = false`:

 * Only show tasks considered “open” (`status:open`).
* When `show_done = true`:

 * Show both open and done tasks (`status:any`).
* This wraps around the current query (view + search).
* Top bar “Flags” section shows `hide-done` or `show-done`.

Implementation detail:

* `show_done` is expressed directly in the query string as a `status:` filter.
* `show_done = false` → ensure query contains `status:open` (remove any existing `status:*` first).
* `show_done = true` → ensure query contains `status:all` (remove any existing `status:*` first).
* This applies consistently in both view-scoped and global search scopes.
* More generally: any interaction that changes what the task list shows must update the displayed query string (view changes, search typing, scope toggles, project drill-down, and `z`).

---

## 7. Task Actions & Mini Menus

All edits:

* Must write changes back to Markdown (`todos.md` or the relevant project file).
* Must update the in-memory task list immediately.
* Must not change non-task content.

### 7.1. Toggle done

* Key: `space`

Behavior:

* Switch `[ ]` ↔ `[x]`.
* Update `status` in index (`open`/`done`).
* Respect `show_done` flag (task may disappear if hiding done).

### 7.2. Priority mini menu

* Key: `p`

Popup:

```text
Set priority for: Draft welcome email

 [h] high
 [n] normal
 [l] low
 [c] clear

 [Esc] cancel
```

Effects:

* `h` → `priority:high`
* `n` → `priority:normal`
* `l` → `priority:low`
* `c` → remove `priority` key.

### 7.3. Bucket mini menu

* Key: `b`

Popup:

```text
Set bucket for: Draft welcome email

 [t] today
 [u] upcoming
 [a] anytime
 [s] someday
 [c] clear

 [Esc] cancel
```

Effects:

* `t` → `bucket:today`, and if `plan` empty, set `plan:<today>`.
* `u` → `bucket:upcoming`.
* `a` → `bucket:anytime`.
* `s` → `bucket:someday`.
* `c` → remove `bucket`.

### 7.4. Plan date mini menu

* Key: `n`

Popup:

```text
Plan date for: Draft welcome email

 [t] today
 [m] manual (YYYY-MM-DD or +Nd/+Nw)
 [c] clear

 Input: _
```

Effects:

* `t` → `plan:<today>`.
* `m`:

 * Ask for input: `YYYY-MM-DD` or a shortcut like `+1d`, `+3d`, `+1w`.
 * Convert to canonical `YYYY-MM-DD` and set `plan:...`.
* `c` → clear `plan`.

### 7.5. Due date mini menu

* Key: `d`

Popup:

```text
Due date for: Draft welcome email

 [t] today
 [m] manual (YYYY-MM-DD or +Nd/+Nw)
 [c] clear

 Input: _
```

Effects:

* Same as plan date, but sets/clears `due`.

### 7.6. Edit full task text / metadata

* Key: `e`

Two possible behaviors (implementation choice):

1. **Inline mini editor (v1 simple)**:

 * Popup shows two fields:

 * Task text (single line or wrapped).
 * Metadata block `[key:value ...]`.
 * User edits and saves.
 * TUI rewrites that line in Markdown.

2. **External editor (advanced option)**:

 * `e` opens the task’s file in `$EDITOR` at that line.
 * On editor exit, re-parse that file and update in-memory task(s).

V1 can implement 1; 2 can be optional later.

---

## 8. Creating Tasks

* Key: `a` – add a new task.

Context rules:

* In project-specific task view: new task belongs to that project.
* In All/Today/Upcoming/Anytime/Someday:

 * Default to `Inbox` project (or last used project) unless otherwise chosen.

Flow:

1. Prompt: `Task text: _`
2. Prompt: `Priority [h=high, n=normal, l=low, Enter=normal]:`
3. Prompt: `Bucket [t=today, u=upcoming, a=anytime, s=someday, Enter=none]:`
4. Prompt: `Plan date [YYYY-MM-DD or shortcuts, Enter=none]:`
5. Prompt: `Due date [YYYY-MM-DD or shortcuts, Enter=none]:`

Result:

* Append a new Markdown line under the appropriate project heading.
* Create metadata block with:

 * `id` (generated),
 * plus chosen `priority`, `bucket`, `plan`, `due`.
* Add task to in-memory list and show it in the current view if it matches.

---

## 9. File Handling & Soft Protection

### 9.1. Single source of truth

* Markdown files (`todos.md` and any others) are canonical.
* All edits **must** be applied to Markdown, not `todos.json`.

### 9.2. Indexing behavior

On `tmd interactive`:

1. **Startup:**

 * Run `tmd enrich` to ensure tasks have IDs and canonical metadata.
 * Run `tmd index`.
 * Load tasks from `todos.json` (or configured `output` path).

2. **Exit:**

 * Run `tmd index` again to regenerate `todos.json` with all changes.
 * Run `tmd sync` once to regenerate view files.

### 9.3. Task-to-file mapping

Index (`todos.json`) must contain enough info to locate tasks:

* `file_path`
* `project_id`
* `local_id` (the per-project task id)
* Optionally a `line_hint` to speed up lookup.

When editing a task:

* The TUI locates the task by its `global_id` (i.e. `project_id:local_id`) and rewrites the line in that file.
* Fast path: use the in-memory task’s `lineNumber` as a hint (O(1)) and verify that the line still matches the task (`id:<local_id>` + same project context).
* Fallback: if verification fails (or the file was externally edited), re-parse the file to rebuild the `global_id -> lineNumber` map for that file, then retry the edit.

### 9.4. Soft protection for external edits

Problem: user may edit `todos.md` outside `tmd interactive` while interactive is open.

Requirement:

* On interactive start, record file `mtime` (modification time) for each file.
* Before writing changes to a file:

 * Re-check the file’s current `mtime`.
 * If `mtime` has changed since last time TUI touched it:

 * Show a warning (e.g. in a popup):
 `"File todos.md changed externally. Reload now? (y/n)"`.
 * If user chooses **yes**:

 * Re-parse that file, rebuild `global_id -> lineNumber` mapping, update in-memory tasks from it.
 * Re-apply intended change if still valid.
 * If user chooses **no**:

 * Cancel this edit, keep current in-memory state, and show that the file may be out of sync.

This “soft protection” avoids silently overwriting external changes while keeping behavior simple.

---

## 10. Config Summary for Interactive Mode

Config options relevant to interactive:

* `views` – list of custom views (key, name, query, sort).
* `colors` – optional color settings (or a simple `disable_colors` flag).
* (Future) `keys` – optional key remapping.

Defaults should allow `tmd interactive` to run with **zero config**, using built-in views and default colors.

---

This requirement document should give you (or an AI helper) a clear, end-to-end picture of how `tmd interactive` should look, behave, and integrate with your existing `tmd` CLI and Markdown-based task system.
